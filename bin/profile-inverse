#!/usr/bin/env bash

set -e
set -x

BIN_PATH=target/release/churn_inverse
SRC_ROOT=/Users/mkirk/src/georust/geographiclib-rs
BIN_NAME=$(basename $BIN_PATH)
BASENAME="$BIN_NAME.$(date +\%s)"

mkdir -p profiles

cargo build --release

echo dtracing $BIN_PATH
sudo dtrace -c "${BIN_PATH} --bench" -o "profiles/${BASENAME}.stacks" -n "profile-997 /execname == \"${BIN_NAME}\"/ { @[ustack(100)] = count(); }"

(cd ../FlameGraph && \
./stackcollapse.pl "${SRC_ROOT}/profiles/${BASENAME}.stacks" | ./flamegraph.pl > "${SRC_ROOT}/profiles/${BASENAME}-profile-graph.svg" && \
open "${SRC_ROOT}/profiles/${BASENAME}-profile-graph.svg")

